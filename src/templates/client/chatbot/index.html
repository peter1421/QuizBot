{% extends 'layouts/base.html' %} <br />
{% load static %} <br />
{% block content %}
<!-- Page Content  -->
<div id="content-page" class="content-page">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <div class="iq-card">
          <div class="iq-card-body chat-page p-0">
            <div class="chat-data-block">
              <div class="row">
                <div class="col-lg-4 chat-data-left scroller">
                  <div class="chat-sidebar-channel scroller mt-4 pl-3">
                    <h5 class="mb-0">
                      {{chatbot.account.username}}-{{chatbot.chapter.title}}
                    </h5>
                    <h5 class="mb-0">
                      {{chatbot.account.username}}-{{chatbot.chapter.title}}
                    </h5>
                  </div>
                </div>
                <div class="col-lg-8 chat-data p-0 chat-data-right">
                  <div class="chat-head">
                    <header
                      class="d-flex justify-content-between align-items-center bg-white pt-3 pr-3 pb-3"
                    >
                      <div class="d-flex align-items-center">
                        <div id="sidebar-toggle" class="sidebar-toggle">
                          <i class="ri-menu-3-line"></i>
                        </div>
                        <div class="avatar chat-user-profile m-0 mr-3">
                          <img
                            src="{% static 'images/user/05.jpg' %}"
                            alt="avatar"
                            class="avatar-50"
                          />
                          <span class="avatar-status"
                            ><i
                              class="ri-checkbox-blank-circle-fill text-success"
                            ></i
                          ></span>
                        </div>
                        <input
                          type="hidden"
                          id="chatbotId"
                          value="{{ chatbot.id }}"
                        />
                        <h5 class="mb-0">
                          {{chatbot.account.username}}-{{chatbot.chapter.title}}
                        </h5>
                      </div>
                      <div
                        id="chat-user-detail-popup"
                        class="scroller"
                        class="scroller"
                      >
                        <div class="user-profile text-center">
                          <button type="submit" class="close-popup p-3">
                            <i class="ri-close-fill"></i>
                          </button>
                          <div class="user mb-4">
                            <a class="avatar m-0">
                              <img
                                src="{% static 'images/user/05.jpg' %}"
                                alt="avatar"
                              />
                            </a>
                            <div class="user-name mt-4">
                              <h4>Nik Jordan</h4>
                            </div>
                            <div class="user-desc">
                              <p>Cape Town, RSA</p>
                            </div>
                          </div>
                          <hr />
                          <div class="chatuser-detail text-left mt-4">
                            <div class="row">
                              <div class="col-6 col-md-6 title">Nik Name:</div>
                              <div class="col-6 col-md-6 text-right">Nik</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Tel:</div>
                              <div class="col-6 col-md-6 text-right">
                                072 143 9920
                              </div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">
                                Date Of Birth:
                              </div>
                              <div class="col-6 col-md-6 text-right">
                                July 12, 1989
                              </div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Gender:</div>
                              <div class="col-6 col-md-6 text-right">Male</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Language:</div>
                              <div class="col-6 col-md-6 text-right">
                                Engliah
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="chat-header-icons d-flex">
                        <a href="javascript:void();" class="chat-icon-phone">
                          <i class="ri-phone-line"></i>
                        </a>
                        <a href="javascript:void();" class="chat-icon-video">
                          <i class="ri-vidicon-line"></i>
                        </a>
                        <a href="javascript:void();" class="chat-icon-delete">
                          <i class="ri-delete-bin-line"></i>
                        </a>
                        <span class="dropdown">
                          <i
                            class="ri-more-2-line cursor-pointer dropdown-toggle nav-hide-arrow cursor-pointer pr-0"
                            id="dropdownMenuButton"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false"
                            role="menu"
                          ></i>
                          <span
                            class="dropdown-menu dropdown-menu-right"
                            aria-labelledby="dropdownMenuButton"
                          >
                            <a class="dropdown-item" href="JavaScript:void(0);"
                              ><i
                                class="fa fa-thumb-tack"
                                aria-hidden="true"
                              ></i>
                              Pin to top</a
                            >
                            <a class="dropdown-item" href="JavaScript:void(0);"
                              ><i class="fa fa-trash-o" aria-hidden="true"></i>
                              Delete chat</a
                            >
                            <a class="dropdown-item" href="JavaScript:void(0);"
                              ><i class="fa fa-ban" aria-hidden="true"></i>
                              Block</a
                            >
                          </span>
                        </span>
                      </div>
                    </header>
                  </div>
                  <div class="chat-content scroller"></div>
                  <div class="chat-footer p-3 bg-white">
                    <form
                      class="d-flex align-items-center"
                      action="javascript:void(0);"
                    >
                      <div class="chat-attagement d-flex">
                        <a href="javascript:void();"
                          ><i class="fa fa-smile-o pr-3" aria-hidden="true"></i
                        ></a>
                        <a href="javascript:void();"
                          ><i
                            class="fa fa-paperclip pr-3"
                            aria-hidden="true"
                          ></i
                        ></a>
                      </div>

                      <input
                        type="text"
                        class="form-control mr-3"
                        placeholder="è«‹è¼¸å…¥å…§å®¹"
                      />
                      <button
                        button
                        type="submit"
                        id="sendButton"
                        class="btn btn-primary d-flex align-items-center p-2"
                      >
                        <i class="fa fa-paper-plane-o" aria-hidden="true"></i
                        ><span class="d-none d-lg-block ml-1">æäº¤</span>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    //TODO:æ•´ç†
    $(document).ready(function () {
      initMessages();
      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
      function loadingMessage() {
        const cards = [
          {
            name: "ä¸­å¤®å¤§å­¸",
            rarity: "â­â­â­â­â­ï¼ˆè¶…ç´šç¨€æœ‰ï¼‰",
            fortune:
              "åœ‹ç«‹ä¸­å¤®å¤§å­¸æ˜¯ä¸€æ‰€ç©æ¥µæ–°å‰µã€å­¸ç§‘é½Šå…¨ã€å­¸è¡“å¯¦åŠ›é›„åšã€è¾¦å­¸ç‰¹è‰²é®®æ˜ï¼Œåœ¨åœ‹éš›ä¸Šå…·æœ‰é‡è¦å½±éŸ¿åŠ›èˆ‡ç«¶çˆ­åŠ›çš„ç¶œåˆæ€§å¤§å­¸ï¼Œåœ¨å¤šå€‹å­¸è¡“é ˜åŸŸå…·æœ‰éå¸¸å‰ç»çš„ç§‘æŠ€å¯¦åŠ›ï¼Œæ“æœ‰ä¸–ç•Œä¸€æµçš„å¯¦é©—å®¤èˆ‡å¸«è³‡åŠ›é‡ï¼Œå„ç¨®æ’åå‡ä½æ–¼å…¨çƒå‰åˆ—ã€‚æ­¡è¿å¤§å®¶å ±è€ƒåœ‹ç«‹ä¸­å¤®å¤§å­¸ã€‚",
            luck: "å¤§å‡¶",
            weight: 10, // æ›´ç¨€æœ‰ï¼Œæƒé‡è¾ƒä½
          },
          {
            name: "è£å‰©èšŠ",
            rarity: "â­â­â­â­â­ï¼ˆè¶…ç´šç¨€æœ‰ï¼‰",
            fortune: "ä½ ä»Šå¤©å¯èƒ½æœƒè¢«æ€ªä¼¯ä¼¯ç³¾çºã€‚",
            luck: "å¤§å‡¶",
            weight: 10, // æ›´ç¨€æœ‰ï¼Œæƒé‡è¾ƒä½
          },
          {
            name: "æ˜Ÿè¾°å°å¸«",
            rarity: "â­â­â­â­â­ï¼ˆè¶…ç´šç¨€æœ‰ï¼‰",
            fortune:
              "ä»Šæ—¥ä½ å°‡é‡è¦‹é‡è¦çš„äººæˆ–äº‹ï¼Œé€™å°‡æ˜¯æ¨å‹•ä½ å‰é€²çš„é—œéµã€‚æŠ“ä½æ©Ÿæœƒï¼Œå¤§è†½å‰è¡Œï¼Œä½ çš„å‹‡æ°£å°‡æœƒå¾—åˆ°å®‡å®™çš„çè³ã€‚",
            luck: "å¤§å‰",
            weight: 2, // æ›´ç¨€æœ‰ï¼Œæƒé‡è¾ƒä½
          },
          {
            name: "æµ·æ´‹é ˜èˆªè€…",
            rarity: "â­â­â­â­ï¼ˆç¨€æœ‰ï¼‰",
            fortune:
              "æ½®æ±å¸¶ä¾†æ–°çš„é–‹å§‹ã€‚ä½ å°‡åœ¨äººéš›é—œä¿‚ä¸­ç™¼ç¾æ–°çš„å¯èƒ½ï¼Œæ–°æœ‹å‹æˆ–åˆä½œä¼™ä¼´å°‡ç‚ºä½ å¸¶ä¾†ç›Šè™•ã€‚",
            luck: "ä¸­å‰",
            weight: 6, // è¾ƒå¸¸è§ï¼Œæƒé‡é€‚ä¸­
          },
          {
            name: "çŸ¥è­˜å®ˆè­·è€…",
            rarity: "â­â­â­ï¼ˆä¸­ç­‰ç¨€æœ‰ï¼‰",
            fortune:
              "å­¸ç¿’å’Œæˆé•·å°‡æ˜¯ä»Šå¤©çš„ä¸»é¡Œã€‚å¸æ”¶æ–°çŸ¥è­˜ï¼Œé€™å°‡ç‚ºæœªä¾†çš„æŒ‘æˆ°è£å‚™è‡ªå·±ã€‚",
            luck: "å°å‰",
            weight: 8, // æ›´å¸¸è§ï¼Œæƒé‡è¾ƒé«˜
          },
          {
            name: "ç½å„ä¹‹å½±",
            rarity: "â­â­â­â­â­ï¼ˆè¶…ç´šç¨€æœ‰ï¼‰",
            fortune: "å°å¿ƒä»Šå¤©çš„é¸æ“‡ï¼Œå¯èƒ½å¸¶ä¾†æœªæ–™çš„å›°é›£æˆ–æå¤±ã€‚",
            luck: "å¤§å‡¶",
            weight: 2, // è¶…ç´šç¨€æœ‰ï¼Œä½†å¸¦æ¥çš„ä¸æ˜¯å¥½è¿
          },
          {
            name: "è¿·å¤±è€…",
            rarity: "â­â­â­ï¼ˆä¸­ç­‰ç¨€æœ‰ï¼‰",
            fortune: "å¯èƒ½æœƒæ„Ÿåˆ°è¿·èŒ«å’Œå¤±è½ï¼Œå»ºè®®ä»Šå¤©é¿å…é‡è¦å†³ç­–ã€‚",
            luck: "å‡¶",
            weight: 6,
          },
          {
            name: "éºå¿˜çš„èª“è¨€",
            rarity: "â­â­â­â­ï¼ˆç¨€æœ‰ï¼‰",
            fortune: "éå»çš„æ‰¿è«¾å¯èƒ½æœƒé€ æˆä»Šå¤©çš„å›°æ“¾ï¼Œå°å¿ƒå¤„ç†äººé™…å…³ç³»ã€‚",
            luck: "å°å‡¶",
            weight: 7,
          },
          {
            name: "é€†é¢¨è¡Œè€…",
            rarity: "â­â­â­â­â­ï¼ˆè¶…ç´šç¨€æœ‰ï¼‰",
            fortune: "ä»Šæ—¥é¢è‡¨é€†å¢ƒï¼Œéœ€è¦é¢å¤–çš„åŠªåŠ›å’Œè€å¿ƒæ‰èƒ½å…‹æœã€‚",
            luck: "å‡¶",
            weight: 4,
          },
          {
            name: "å¹½è°·è¡Œè€…",
            rarity: "â­â­ï¼ˆè¼ƒå¸¸è¦‹ï¼‰",
            fortune: "å¯èƒ½æœƒé‡åˆ°æ„æ–™ä¹‹å¤–çš„æŒ‘æˆ˜ï¼Œå»ºè®®ä¿æŒä½è°ƒã€‚",
            luck: "ä¸­å‡¶",
            weight: 10,
          },
        ];

        // è®¡ç®—æ€»æƒé‡
        const totalWeight = cards.reduce(
          (total, card) => total + card.weight,
          0
        );

        // éšæœºé€‰æ‹©å¡ç‰‡ï¼Œæ ¹æ®æƒé‡
        let random = Math.random() * totalWeight;
        let selectedCard;
        for (const card of cards) {
          if (random < card.weight) {
            selectedCard = card;
            break;
          }
          random -= card.weight;
        }

        const randomImage =
          Math.random() < 0.5 ? "input_load.gif" : "input_load2.gif";

        return `
        <div id="loadingMessage">
          <div class="chat chat-left">
            <div class="chat-user">
                <a class="avatar m-0">
                    <img src="{% static 'images/user/1.jpg' %}" alt="avatar" class="avatar-35" />
                </a>
                <span class="chat-time mt-1">12:00</span>
            </div>
            <div class="chat-detail">
                <div class="chat-message"><img class="mt-2 img-fluid rounded" src="{% static '/assets/images/${randomImage}' %}" width="100" height="100"></div>
                <div class="chat-message"><p>ğŸ”® æŠ½å¡çµæœ ğŸ”®<br><strong>æœ¬æ—¥æŠ½å¡ï¼š</strong>${selectedCard.luck}<br><strong>ç¨€æœ‰åº¦ï¼š</strong>${selectedCard.rarity}<br><strong>èªªæ˜ï¼š</strong>${selectedCard.fortune}</div>
            </div>
          </div>
        </div>`;
      }
      function appendMessage(side, imgSrc, time, messageText) {
        const sideClass = side === "assistant" ? " chat-left" : ""; // æ ¹æ“šç™¼é€æ–¹æ±ºå®šæ¶ˆæ¯æ¡†ä½ç½®
        return `
      <div class="chat${sideClass}">
          <div class="chat-user">
              <a class="avatar m-0">
                  <img src="${imgSrc}" alt="avatar" class="avatar-35" />
              </a>
              <span class="chat-time mt-1">${time}</span>
          </div>
          <div class="chat-detail">
              <div class="chat-message"><p>${messageText}</p></div>
          </div>
      </div>`;
      }
      function speak(text) {
        // å‰µå»ºä¸€å€‹æ–°çš„ SpeechSynthesisUtterance å¯¦ä¾‹
        var utterance = new SpeechSynthesisUtterance(text);

        // é¸æ“‡èªéŸ³ã€‚é€™æ˜¯å¯é¸çš„ï¼Œä¹Ÿå¯ä»¥ç•™ç©ºä½¿ç”¨ç³»çµ±é è¨­èªéŸ³
        var voices = window.speechSynthesis.getVoices();
        utterance.voice = voices.filter(function (voice) {
          return voice.lang === "zh-TW";
        })[0]; // é¸æ“‡ç‰¹å®šèªè¨€çš„èªéŸ³ï¼Œé€™è£¡ä»¥ç¹é«”ä¸­æ–‡ç‚ºä¾‹

        // è¨­ç½®å…¶ä»–å±¬æ€§ï¼Œå¦‚èªé€Ÿå’ŒéŸ³èª¿
        utterance.rate = 1; // èªé€Ÿï¼Œç¯„åœå¾0.1è‡³10ï¼Œé è¨­ç‚º1
        utterance.pitch = 1; // éŸ³èª¿ï¼Œç¯„åœå¾0è‡³2ï¼Œé è¨­ç‚º1

        // å°‡utteranceå‚³çµ¦speechSynthesisä»‹é¢
        window.speechSynthesis.speak(utterance);
      }
      // æ ¼å¼åŒ–æ™‚é–“ç‚º HH:MM æ ¼å¼
      function formattedTime(date) {
        return `${date.getHours()}:${date.getMinutes().toString().padStart(2, "0")}`;
      }
      function initMessages() {
        const chatbotId = $("#chatbotId").val();
        fetchAndDisplayMessages(chatbotId);
      }
      function fetchAndDisplayMessages(chatbotId) {
        $.ajax({
          url: "{% url 'api_get_message_by_chatbot_id' %}",
          type: "GET",
          data: { chatbot_id: chatbotId },
          dataType: "json", // é æœŸå¾æœå‹™å™¨è¿”å› JSON æ•¸æ“š
          success: function (response) {
            const chatContainer = $(".chat-content");
            chatContainer.empty(); // æ¸…ç©ºç•¶å‰å…§å®¹ï¼Œæº–å‚™é¡¯ç¤ºæ–°æ¶ˆæ¯

            response.forEach(function (message) {
              const createdAt = new Date(message.created_at);
              const messageElement = appendMessage(
                message.role,
                '{% static "images/user/1.jpg" %}',
                formattedTime(createdAt),
                message.content
              );
              chatContainer.append(messageElement);
            });
            chatContainer.scrollTop(chatContainer.prop("scrollHeight")); // æ»¾å‹•åˆ°æœ€åº•éƒ¨
          },
          error: function (xhr, status, error) {
            alert("ç„¡æ³•å¾ä¼ºæœå™¨ç²å–æ¶ˆæ¯ï¼š" + error);
          },
        });
      }
      // å°è£çš„ AJAX è«‹æ±‚å‡½æ•¸
      function sendChatRequest(message, onSuccess, onError) {
        const chatbotId = $("#chatbotId").val(); // ç²å–èŠå¤©æ©Ÿå™¨äººçš„ ID

        $.ajax({
          url: "{% url 'api_chat_with_bot' %}",
          type: "POST",
          data: {
            csrfmiddlewaretoken: "{{ csrf_token }}",
            message: message,
            chatbot_id: chatbotId,
          },
          success: onSuccess, // ä½¿ç”¨å›èª¿å‡½æ•¸è™•ç†æˆåŠŸæƒ…æ³
          error: onError, // ä½¿ç”¨å›èª¿å‡½æ•¸è™•ç†éŒ¯èª¤æƒ…æ³
        });
      }

      // è™•ç†ç™¼é€æ¶ˆæ¯çš„åŠŸèƒ½
      function sendMessage(message) {
        const chatContainer = $(".chat-content");
        const now = new Date();
        const userMessage = appendMessage(
          "user",
          '{% static "images/user/1.jpg" %}',
          formattedTime(now),
          message
        );

        chatContainer.append(userMessage);
        
        chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        // å»¶è¿Ÿ 0.5 ç§’åæ»šåŠ¨åˆ°èŠå¤©å®¹å™¨çš„åº•éƒ¨
        setTimeout(function () {
          chatContainer.append(loadingMessage);
          chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        }, 1000);

        // é¡¯ç¤ºåŠ è¼‰å‹•ç•«

        sendChatRequest(
          message,
          function (data) {
            $("#loadingMessage").remove();
            const createdAt = new Date(data.data.created_at);
            const botMessage = appendMessage(
              data.data.role,
              '{% static "images/user/05.jpg" %}',
              formattedTime(createdAt),
              data.data.content
            );
            speak(data.data.content);
            chatContainer.append(botMessage);
            chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
          },
          function (xhr, status, error) {
            alert("AJAX éŒ¯èª¤: " + error);
            console.error("AJAX éŒ¯èª¤:", error);
          }
        );
      }

      $("form").submit(function (e) {
        e.preventDefault();
        const message = $('input[type="text"]').val();
        if (message.trim() !== "") {
          sendMessage(message);
          $('input[type="text"]').val("");
        }
      });
    });
  </script>
</div>
{% endblock content %}
