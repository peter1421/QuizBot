{% extends 'layouts/base.html' %} <br />
{% load static %} <br />
{% block content %}
<!-- Page Content  -->
<div id="content-page" class="content-page">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <div class="iq-card">
          <div class="iq-card-body chat-page p-0">
            <div class="chat-data-block">
              <div class="row">
                <div class="col-lg-4 chat-data-left scroller">
                  <div class="chat-sidebar-channel scroller mt-4 pl-3">
                    <h5 class="mb-0">{{chatbot.account.username}}-{{chatbot.chapter.title}}</h5>
                    <h5 class="mb-0">{{chatbot.account.username}}-{{chatbot.chapter.title}}</h5>
                  </div>
                </div>
                <div class="col-lg-8 chat-data p-0 chat-data-right">
                  <div class="chat-head">
                    <header
                      class="d-flex justify-content-between align-items-center bg-white pt-3 pr-3 pb-3"
                    >
                      <div class="d-flex align-items-center">
                        <div id="sidebar-toggle" class="sidebar-toggle">
                          <i class="ri-menu-3-line"></i>
                        </div>
                        <div class="avatar chat-user-profile m-0 mr-3">
                          <img
                            src="{% static 'images/user/05.jpg' %}"
                            alt="avatar"
                            class="avatar-50"
                          />
                          <span class="avatar-status"
                            ><i
                              class="ri-checkbox-blank-circle-fill text-success"
                            ></i
                          ></span>
                        </div>
                        <input type="hidden" id="chatbotId" value="{{ chatbot.id }}">
                        <h5 class="mb-0">
                          {{chatbot.account.username}}-{{chatbot.chapter.title}}
                        </h5>
                      </div>
                      <div
                        id="chat-user-detail-popup"
                        class="scroller"
                        class="scroller"
                      >
                        <div class="user-profile text-center">
                          <button type="submit" class="close-popup p-3">
                            <i class="ri-close-fill"></i>
                          </button>
                          <div class="user mb-4">
                            <a class="avatar m-0">
                              <img
                                src="{% static 'images/user/05.jpg' %}"
                                alt="avatar"
                              />
                            </a>
                            <div class="user-name mt-4">
                              <h4>Nik Jordan</h4>
                            </div>
                            <div class="user-desc">
                              <p>Cape Town, RSA</p>
                            </div>
                          </div>
                          <hr />
                          <div class="chatuser-detail text-left mt-4">
                            <div class="row">
                              <div class="col-6 col-md-6 title">Nik Name:</div>
                              <div class="col-6 col-md-6 text-right">Nik</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Tel:</div>
                              <div class="col-6 col-md-6 text-right">
                                072 143 9920
                              </div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">
                                Date Of Birth:
                              </div>
                              <div class="col-6 col-md-6 text-right">
                                July 12, 1989
                              </div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Gender:</div>
                              <div class="col-6 col-md-6 text-right">Male</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Language:</div>
                              <div class="col-6 col-md-6 text-right">
                                Engliah
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="chat-header-icons d-flex">
                        <a href="javascript:void();" class="chat-icon-phone">
                          <i class="ri-phone-line"></i>
                        </a>
                        <a href="javascript:void();" class="chat-icon-video">
                          <i class="ri-vidicon-line"></i>
                        </a>
                        <a href="javascript:void();" class="chat-icon-delete">
                          <i class="ri-delete-bin-line"></i>
                        </a>
                        <span class="dropdown">
                          <i
                            class="ri-more-2-line cursor-pointer dropdown-toggle nav-hide-arrow cursor-pointer pr-0"
                            id="dropdownMenuButton"
                            data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="false"
                            role="menu"
                          ></i>
                          <span
                            class="dropdown-menu dropdown-menu-right"
                            aria-labelledby="dropdownMenuButton"
                          >
                            <a class="dropdown-item" href="JavaScript:void(0);"
                              ><i
                                class="fa fa-thumb-tack"
                                aria-hidden="true"
                              ></i>
                              Pin to top</a
                            >
                            <a class="dropdown-item" href="JavaScript:void(0);"
                              ><i class="fa fa-trash-o" aria-hidden="true"></i>
                              Delete chat</a
                            >
                            <a class="dropdown-item" href="JavaScript:void(0);"
                              ><i class="fa fa-ban" aria-hidden="true"></i>
                              Block</a
                            >
                          </span>
                        </span>
                      </div>
                    </header>
                  </div>
                  <div class="chat-content scroller">
                  </div>
                  <div class="chat-footer p-3 bg-white">
                    <form
                      class="d-flex align-items-center"
                      action="javascript:void(0);"
                    >
                      <div class="chat-attagement d-flex">
                        <a href="javascript:void();"
                          ><i class="fa fa-smile-o pr-3" aria-hidden="true"></i
                        ></a>
                        <a href="javascript:void();"
                          ><i
                            class="fa fa-paperclip pr-3"
                            aria-hidden="true"
                          ></i
                        ></a>
                      </div>
                      
                      <input
                        type="text"
                        class="form-control mr-3"
                        placeholder="請輸入內容"
                      />
                      <button
                        button type="submit" id="sendButton"
                        class="btn btn-primary d-flex align-items-center p-2"
                      >
                        <i class="fa fa-paper-plane-o" aria-hidden="true"></i
                        ><span class="d-none d-lg-block ml-1">提交</span>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(document).ready(function () {
      function appendMessage(side, imgSrc, time, messageText) {
        const sideClass = side === "left" ? " chat-left" : "";
        return `
                <div class="chat${sideClass}">
                    <div class="chat-user">
                        <a class="avatar m-0">
                            <img src="${imgSrc}" alt="avatar" class="avatar-35" />
                        </a>
                        <span class="chat-time mt-1">${time}</span>
                    </div>
                    <div class="chat-detail">
                        <div class="chat-message"><p>${messageText}</p></div>
                    </div>
                </div>`;
      }
      function sendMessage(message) {
        var chatbotId = $('#chatbotId').val();
        var chatContainer = $(".chat-content");
        const userMessage = appendMessage(
              "",
              '{% static "images/user/1.jpg" %}',
              "6:45",
              message
            );
        chatContainer.append(userMessage);
        chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        $.ajax({
          url: "{% url 'api_chat_with_bot' %}",
          type: "POST",
          data: { csrfmiddlewaretoken: "{{ csrf_token }}", message: message, chatbot_id:chatbotId},
          success: function (data) {
            const botMessage = appendMessage(
              "left",
              '{% static "images/user/05.jpg" %}',
              "6:48",
              data.message
            );

            chatContainer.append(botMessage);
            chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
          },
          error: function (xhr, status, error) {
            console.error("AJAX Error:", error);
          },
        });
      }

      $("form").submit(function (e) {
        e.preventDefault();
        const message = $('input[type="text"]').val();
        if (message.trim() !== "") {
          sendMessage(message);
          $('input[type="text"]').val("");
        }
      });
    });
  </script>
</div>
{% endblock content %}
