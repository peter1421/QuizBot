{% extends 'layouts/base.html' %} <br />
{% load static %} <br />
{% block content %}
<!-- Page Content  -->
<div id="content-page" class="content-page">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <!-- Inline CSS -->
        <div class="iq-card">
          <div class="iq-card-body chat-page p-0">
            <div class="chat-data-block">
              <div class="row">
                <div class="col-lg-6 chat scroller">
                  <div class="chat-sidebar-channel scroller mt-4">
                    <ul class="nav nav-pills mb-3 nav-fill" id="pills-tab-1" role="tablist">
                      <li class="nav-item">
                        <a class="nav-link" id="pills-home-tab-fill" data-toggle="pill" href="#code-container" role="tab" aria-controls="pills-home" aria-selected="false" _msttexthash="2136498" _msthash="165">無資料</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link active" id="pills-profile-tab-fill" data-toggle="pill" href="#pills-profile-fill" role="tab" aria-controls="pills-profile" aria-selected="true" _msttexthash="5859750" _msthash="166">無資料</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" id="pills-contact-tab-fill" data-toggle="pill" href="#pills-contact-fill" role="tab" aria-controls="pills-contact" aria-selected="false" _msttexthash="6357741" _msthash="167">無資料</a>
                      </li>
                    </ul>
                    <div class="tab-content" id="pills-tabContent-1">
                      <div class="tab-pane fade" id="code-container" role="tabpanel" aria-labelledby="pills-home-tab-fill">
                        <p>空的</p>
                      </div>
                      <div class="tab-pane show active" id="pills-profile-fill" role="tabpanel" aria-labelledby="pills-profile-tab-fill">
                        <div class="row">
                          <p>空的</p>
                        </div>
                      </div>
                      <div class="tab-pane fade" id="pills-contact-fill" role="tabpanel" aria-labelledby="pills-contact-tab-fill">
                          <div class="col-sm-12">{% include 'client/chatbot/update_file.html' %}</div>
                          <p>空的</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6 chat-data p-0 chat-data-right">
                  <div class="chat-head">
                    <header class="d-flex justify-content-between align-items-center bg-white pt-3 pr-3 pb-3">
                      <div class="d-flex align-items-center">
                        <div id="sidebar-toggle" class="sidebar-toggle">
                          <i class="ri-menu-3-line"></i>
                        </div>
                        <div class="avatar chat-user-profile m-0 mr-3">
                          <img src="{% static 'images/user/05.jpg' %}" alt="avatar" class="avatar-50" />
                          <span class="avatar-status"><i class="ri-checkbox-blank-circle-fill text-success"></i></span>
                        </div>
                        <input type="hidden" id="chatbotId" value="{{ chatbot.id }}" />
                        <h5 class="mb-0">{{chatbot.account.username}}-{{chatbot.chapter.title}}</h5>
                      </div>
                      <div id="chat-user-detail-popup" class="scroller">
                        <div class="user-profile text-center">
                          <button type="submit" class="close-popup p-3">
                            <i class="ri-close-fill"></i>
                          </button>
                          <div class="user mb-4">
                            <a class="avatar m-0">
                              <img src="{% static 'images/user/05.jpg' %}" alt="avatar" />
                            </a>
                            <div class="user-name mt-4">
                              <h4>Nik Jordan</h4>
                            </div>
                            <div class="user-desc">
                              <p>Cape Town, RSA</p>
                            </div>
                          </div>
                          <hr />
                          <div class="chatuser-detail text-left mt-4">
                            <div class="row">
                              <div class="col-6 col-md-6 title">Nik Name:</div>
                              <div class="col-6 col-md-6 text-right">Nik</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Tel:</div>
                              <div class="col-6 col-md-6 text-right">072 143 9920</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Date Of Birth:</div>
                              <div class="col-6 col-md-6 text-right">July 12, 1989</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Gender:</div>
                              <div class="col-6 col-md-6 text-right">Male</div>
                            </div>
                            <hr />
                            <div class="row">
                              <div class="col-6 col-md-6 title">Language:</div>
                              <div class="col-6 col-md-6 text-right">English</div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="chat-header-icons d-flex">
                        <a href="javascript:void();" class="chat-icon-delete" id="updateThreadsButton">
                          <i class="ri-delete-bin-line"></i>
                        </a>
                        <span class="dropdown">
                          <i class="ri-more-2-line cursor-pointer dropdown-toggle nav-hide-arrow cursor-pointer pr-0" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" role="menu"></i>
                          <span class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="JavaScript:void(0);"><i class="fa fa-thumb-tack" aria-hidden="true"></i> Pin to top</a>
                            <a class="dropdown-item" href="JavaScript:void(0);"><i class="fa fa-trash-o" aria-hidden="true"></i> Delete chat</a>
                            <a class="dropdown-item" href="JavaScript:void(0);"><i class="fa fa-ban" aria-hidden="true"></i> Block</a>
                          </span>
                        </span>
                      </div>
                    </header>
                  </div>
                  <div class="chat-content scroller"></div>
                  <div class="chat-footer">
                    <button type="button" class="btn btn-outline-primary btn-sm rounded-pill mt-2" id="sayHi"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">打招呼</font></button>

                    <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill mt-2" id="askQuestionButton"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">窩不知道</font></button>
                    <button type="button" class="btn btn-outline-success btn-sm rounded-pill mt-2" id="askAns"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">索取答案</font></button>
                    {% comment %} <button type="button" class="btn btn-outline-danger btn-sm rounded-pill mt-2" id="q1Ans"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">Q1答案</font></button>
                    <button type="button" class="btn btn-outline-danger btn-sm rounded-pill mt-2" id="q2Ans"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">Q2答案</font></button>
                    <button type="button" class="btn btn-outline-danger btn-sm rounded-pill mt-2" id="q2_2Ans"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">Q2答案V2</font></button>
                    <button type="button" class="btn btn-outline-danger btn-sm rounded-pill mt-2" id="q3Ans"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">Q3答案</font></button>
                    <button type="button" class="btn btn-outline-danger btn-sm rounded-pill mt-2" id="q3_2Ans"><font _mstmutation="1" _msttexthash="6549062" _msthash="137">Q3V2答案</font></button> {% endcomment %}
                    {% comment %} {% endcomment %}
                  </div>
                  <div class="chat-footer p-1 bg-white">
                    <form class="d-flex align-items-center" action="javascript:void(0);">
                      <div class="chat-attagement d-flex">
                        {% comment %} <input type="file" class="form-control-file" id="uploadFileButton"  /> {% endcomment %}
                        {% comment %} <a href="javascript:void();"><i class="fa fa-file pr-3" id="submitFileButton" aria-hidden="true"></i> </a> {% endcomment %}
                        <a href="javascript:void();"><i class="fa fa-microphone pr-3" id="trigger" aria-hidden="true"></i> </a>
                      </div>

                      <input type="text" class="form-control mr-3" id="target" placeholder="請輸入內容" />
                      <button button type="submit" id="sendButton" class="btn btn-primary d-flex align-items-center p-2"><i class="fa fa-paper-plane-o" aria-hidden="true"></i><span class="d-none d-lg-block ml-1">➤</span></button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(document).ready(function () {
      const chatContainer = $(".chat-content");
      let messageElements = [];

      init();
      //https://ppcode.net/blog/zh-tw/post/implement-syntax-highlighting-one-click-copy-button-using-highlight-js
      function init() {
        initHljs();
        const chatbotId = $("#chatbotId").val();
        // 使用回调确保消息加载完毕后再继续
        fetchAndDisplayMessages(chatbotId, function () {
          setRocognition();
        });
      }
      function question() {
        const questions = ["S = 'NCU is Apple Pen'，請問S[7:12]會從字串S中取出什麼內容並解釋原理？", "請解釋在Python中，比較運算子`x == y`和`x is y`之間的差異。", "在什麼情況下應該使用 while True 循環？請給出一個實際應用場景，並解釋其在該場景中的使用及潛在風險。"];
        let currentQuestionIndex = 0;

        function askNextQuestion() {
          setTimeout(() => {
            if (currentQuestionIndex < questions.length) {
              messageElements.push(updateMessage("assistant", questions[currentQuestionIndex]));
            } else {
              endMessageText = "所有問題都已回答完畢，接下來我會將這次測驗的所有訊息做出總結，你可以開始與我討論。";
              const messages = [{ role: "assistant", content: endMessageText }];
              messageElements.push(updateMessage("assistant", endMessageText));
              sendMessage(messages);
            }
          }, 2000); // 2000 毫秒後執行，即 2 秒
        }

        $("form").submit(function (e) {
          e.preventDefault();
          const messageText = $('input[type="text"]').val().trim();
          if (messageText === "") {
            alert("請輸入回答後再提交。");
            return;
          }
          if (currentQuestionIndex < questions.length) {
            const confirmSubmit = confirm("您確定要提交答案嗎？");
            if (confirmSubmit) {
              messageElements.push(updateMessage("user", messageText));
              $('input[type="text"]').val(""); // 清空輸入框
              const messages = [
                { role: "assistant", content: questions[currentQuestionIndex] },
                { role: "user", content: messageText }
              ];
              // 发送消息，并在回调中执行后续的提问
              sendMessage(messages, function () {
                currentQuestionIndex++;

                askNextQuestion(); // 现在放在回调中执行
              });
            }
          } else {
            messageElements.push(updateMessage("user", messageText));
            $('input[type="text"]').val(""); // 清空輸入框
            const messages = [{ role: "user", content: messageText }];
            sendMessage(messages);
          }
        });

        // 啟動問題循環
        askNextQuestion();
      }
      function initHljs() {
        hljs.initHighlighting.called = false;
        hljs.initHighlighting();
        hljs.highlightAll();
        hljs.initLineNumbersOnLoad();
        hljs.addPlugin(new CopyButtonPlugin());
      }
      function setRocognition() {
        // 檢查瀏覽器是否支持SpeechRecognition API
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (typeof window.SpeechRecognition === "undefined") {
          alert("您的瀏覽器不支持語音識別功能。");
        } else {
          const recognition = new SpeechRecognition();
          recognition.lang = "zh-TW"; // 設定語言
          recognition.interimResults = false; // 是否返回臨時結果
          let isRecording = false;

          recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript; // 獲取識別結果
            $("#target").val(transcript); // 將結果填入輸入框
            toggleRecording(); // 結束後切換icon
          };

          recognition.onerror = function (event) {
            console.error("語音識別錯誤:", event.error);
            toggleRecording(); // 發生錯誤時切換icon
          };

          $("#trigger").on("click", function () {
            if (isRecording) {
              recognition.stop(); // 停止識別
              toggleRecording(); // 切換icon
            } else {
              recognition.start(); // 開始識別
              toggleRecording(); // 切換icon
            }
          });

          function toggleRecording() {
            isRecording = !isRecording;
            if (isRecording) {
              $("#trigger").removeClass("fa-microphone").addClass("fa-stop");
            } else {
              $("#trigger").removeClass("fa-stop").addClass("fa-microphone");
            }
          }
        }
      }
      // 添加消息到聊天界面
      // 格式化時間為 HH:MM 格式
      function formattedTime(date) {
        return `${date.getHours()}:${date.getMinutes().toString().padStart(2, "0")}`;
      }

      function updateMessage(role, messageText) {
        const now = new Date();
        const message = appendMessage(role, '{% static "images/user/1.jpg" %}', formattedTime(now), (messageText = messageText));

        const messageElement = $(message); // 使用 jQuery 包裝訊息元素
        chatContainer.append(messageElement);
        chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        return messageElement;
      }
      function fetchAndDisplayMessages(chatbotId, callback) {
        $.ajax({
          url: "{% url 'api_get_message_by_chatbot_id' %}",
          type: "GET",
          data: { chatbot_id: chatbotId },
          dataType: "json", // 預期從服務器返回 JSON 數據
          success: function (response) {
            const chatContainer = $(".chat-content");
            //chatContainer.empty(); // 清空當前內容，準備顯示新消息

            response.forEach(function (message) {
              const createdAt = new Date(message.created_at);
              const messageElement = appendMessage(message.role, '{% static "images/user/1.jpg" %}', formattedTime(createdAt), (messageText = message.content));
              chatContainer.append(messageElement);
            });
            chatContainer.scrollTop(chatContainer.prop("scrollHeight")); // 滾動到最底部
            if (callback) callback(); // 执行回调函数
          },
          error: function (xhr, status, error) {
            alert("無法從伺服器獲取消息：" + error);
            if (callback) callback(); // 即使发生错误也执行回调
          }
        });
      }
      // 封裝的 AJAX 請求函數
      function sendChatRequest(requestData, onSuccess, onError) {
        $.ajax({
          headers: {
            "X-CSRFToken": getCookie("csrftoken") // 设置 CSRF 令牌头
          },
          url: "{% url 'api_chat_with_bot' %}",
          type: "POST",
          data: JSON.stringify(requestData), // 將數據轉換為 JSON 字符串
          contentType: "application/json; charset=utf-8", // 設置內容類型為 JSON
          success: onSuccess, // 使用回調函數處理成功情況
          error: onError // 使用回調函數處理錯誤情況
        });
      }

      // 處理發送消息的功能
      function sendMessage(messages, callback) {
        // 延迟后滚动到聊天容器的底部
        // 顯示加載動畫
        setTimeout(function () {
          chatContainer.append(loadingMessage());
          chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        }, 1000);
        const chatbotId = $("#chatbotId").val(); // 獲取聊天機器人的 ID
        // 構造要發送的數據
        const requestData = {
          csrfmiddlewaretoken: "{{ csrf_token }}",
          messages: messages,
          chatbot_id: chatbotId
        };
        sendChatRequest(
          requestData,
          function (response) {
            $("#loadingMessage").remove();
            // 确保是针对 response.data 数组使用 forEach
            response.data.forEach(function (data) {
              const createdAt = new Date(data.created_at);
              const botMessage = appendMessage(
                data.role,
                '{% static "images/user/05.jpg" %}', // 假设这是机器人的头像
                formattedTime(createdAt),
                data.content
              );
              chatContainer.append(botMessage);
            });
            // 移除所有临时消息元素
            messageElements.forEach((element) => element.remove());
            // 清空列表
            chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
            if (callback) callback(); // 成功后执行回调
          },
          function (xhr, status, error) {
            alert("AJAX 錯誤: " + error);
            console.error("AJAX 錯誤:", error);
          }
        );
      }

      $("form").submit(function (e) {
        e.preventDefault();
        const messageText = $('input[type="text"]').val();
        if (messageText.trim() !== "") {
          messageElements.push(updateMessage("user", messageText));
          const messages = [{ role: "user", content: messageText }];
          sendMessage(messages);
          $('input[type="text"]').val("");
        }
      });

      function loadingMessage() {
        const cards = getCardsData();
        const totalWeight = calculateTotalWeight(cards);
        const selectedCard = selectCardByWeight(cards, totalWeight);
        const messageText = generateMessageText(selectedCard);
        const randomImage = chooseRandomImage();
        const time = formattedTime(new Date());
        const imageMessage = generateImageMessage(randomImage, time);
        const textMessage = generateTextMessage(messageText, time);
        return appendMessages(imageMessage, textMessage);
      }

      //TODO:從後端獲取
      function getCardsData() {
        return [
          {
            name: "中央大學",
            rarity: "⭐⭐⭐",
            fortune: "國立中央大學是一所積極新創、學科齊全、學術實力雄厚、辦學特色鮮明，在國際上具有重要影響力與競爭力的綜合性大學，在多個學術領域具有非常前瞻的科技實力，擁有世界一流的實驗室與師資力量，各種排名均位於全球前列。歡迎大家報考國立中央大學。",
            luck: "大凶",
            weight: 4 // 更稀有，权重较低
          },
          {
            name: "裝剩蚊",
            rarity: "⭐⭐⭐⭐⭐",
            fortune: "國立中央大學是一所積極新創、學科齊全、學術實力雄厚、辦學特色鮮明，在國際上具有重要影響力與競爭力的綜合性大學，在多個學術領域具有非常前瞻的科技實力，擁有世界一流的實驗室與師資力量，各種排名均位於全球前列。歡迎大家報考國立中央大學。",
            luck: "大凶",
            weight: 1 // 更稀有，权重较低
          },
          {
            name: "星辰導師",
            rarity: "⭐⭐",
            fortune: "國立中央大學是一所積極新創、學科齊全、學術實力雄厚、辦學特色鮮明，在國際上具有重要影響力與競爭力的綜合性大學，在多個學術領域具有非常前瞻的科技實力，擁有世界一流的實驗室與師資力量，各種排名均位於全球前列。歡迎大家報考國立中央大學。",
            luck: "大吉",
            weight: 2 // 更稀有，权重较低
          },
          {
            name: "海洋領航者",
            rarity: "⭐⭐⭐⭐",
            fortune: "國立中央大學是一所積極新創、學科齊全、學術實力雄厚、辦學特色鮮明，在國際上具有重要影響力與競爭力的綜合性大學，在多個學術領域具有非常前瞻的科技實力，擁有世界一流的實驗室與師資力量，各種排名均位於全球前列。歡迎大家報考國立中央大學。",
            luck: "中吉",
            weight: 6 // 较常见，权重适中
          },
          {
            name: "知識守護者",
            rarity: "⭐⭐⭐",
            fortune: "國立中央大學是一所積極新創、學科齊全、學術實力雄厚、辦學特色鮮明，在國際上具有重要影響力與競爭力的綜合性大學，在多個學術領域具有非常前瞻的科技實力，擁有世界一流的實驗室與師資力量，各種排名均位於全球前列。歡迎大家報考國立中央大學。",
            luck: "小吉",
            weight: 8 // 更常见，权重较高
          },
          {
            name: "災厄之影",
            rarity: "⭐",
            fortune: "國立中央大學是一所積極新創、學科齊全、學術實力雄厚、辦學特色鮮明，在國際上具有重要影響力與競爭力的綜合性大學，在多個學術領域具有非常前瞻的科技實力，擁有世界一流的實驗室與師資力量，各種排名均位於全球前列。歡迎大家報考國立中央大學。",
            luck: "大凶",
            weight: 7 // 超級稀有，但带来的不是好运
          }
        ];
      }
      function chooseRandomImage() {
        return Math.random() < 0.5 ? "{% static 'assets/images/input_load.gif' %}" : "{% static 'assets/images/input_load2.gif' %}";
      }
      function generateImageMessage(imageSource, time) {
        return appendMessage("assistant", '{% static "images/user/05.jpg" %}', time, null, imageSource);
      }

      function generateTextMessage(text, time) {
        return appendMessage("assistant", '{% static "images/user/05.jpg" %}', time, text, null);
      }
      $("#updateThreadsButton").click(function (event) {
        event.preventDefault(); // 阻止默认表单提交行为

        const chatbotId = $("#chatbotId").val(); // 獲取聊天機器人的 ID

        if (!chatbotId) {
          alert("Chatbot ID is required");
          return;
        }

        $.ajax({
          url: "{% url 'api_update_threads' %}",
          type: "POST",
          data: {
            chatbot_id: chatbotId,
            csrfmiddlewaretoken: "{{ csrf_token }}"
          },
          success: function (response) {
            console.log("Success:", response);
            alert("Threads updated: " + response.data);
            window.location.reload();
          },
          error: function (xhr, status, error) {
            console.log("Error:", xhr.responseText);
            alert("Error updating threads: " + xhr.responseText);
          }
        });
      });
      $("#sayHi").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("你好，你覺得我上傳的檔案如何?");
        $("form").submit();
      });
      $("#askQuestionButton").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("這是一個很好的問題");
        $("form").submit();
      });
      $("#askAns").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("請直接給我答案");
        $("form").submit();
      });
      $("#respect").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("看什麼看，過來");
        $("form").submit();
      });
      $("#q1Ans").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("會印出Apple，因為會從字串的第7個字元開始切，並在第12字元停止");
        $("form").submit();
      });
      $("#q2Ans").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("x==y 表示判斷兩個變數是否相同，而x is y 表示他們是否為同一個記憶體位置");
        $("form").submit();
      });
      $("#q3Ans").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("當需要持續執行某個功能時，就會使用while True，例如我需要定時監控某些資料時就能使用，但要注意使否有適合的退出條件，不然可能會無法停止");
        $("form").submit();
      });
      $("#q1_2Ans").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("會印出Apple，因為會從字串的第7個字元開始切，並在第12個字元前停止");
        $("form").submit();
      });
      $("#q2_2Ans").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("x==y 表示判斷兩個變數是否相同，而x is y 表示他們是否為同一個記憶體位置。舉個例子，`a = 10`和`b = 10`，`a == b`必定為真，但是`a is b`不一定，因為他們可能指向不同的記憶體位置，只是數值一樣。");
        $("form").submit();
      });
      $("#q3_2Ans").click(function (event) {
        event.preventDefault(); // 防止任何默认操作
        $('input[type="text"]').val("適合於需要不斷運行直到外部事件觸發結束的情況，如使用者手動停止。例如，在使用者輸入循環中，程序將等待使用者輸入並根據輸入做出反應，直到使用者選擇退出。風險包括如果沒有設置適當的退出機制，可能導致程序無限運行，消耗系統資源。");
        $("form").submit();
      });
      $("#askCodeScore").click(function (event) {
        event.preventDefault(); // 阻止默认表单提交行为

        const chatbotId = $("#chatbotId").val(); // 獲取聊天機器人的 ID

        if (!chatbotId) {
          alert("Chatbot ID is required");
          return;
        }
        sendMessage("user", "請問為什麼這樣評分?");
      });

      $("#uploadFileButton").click(function () {
        var formData = new FormData();
        const chatbotId = $("#chatbotId").val(); // 獲取聊天機器人的 ID
        formData.append("file", $("input[type=file]")[0].files[0]);
        formData.append("chatbot_id", chatbotId);
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}"); // 添加 CSRF token
        $.ajax({
          headers: {
            "X-CSRFToken": getCookie("csrftoken") // 设置 CSRF 令牌头
          },
          url: "{% url 'api_upload_file' %}",
          type: "POST",
          data: formData,
          processData: false, // 告訴jQuery不要處理發送的數據
          contentType: false, // 告訴jQuery不要設置Content-Type請求頭
          success: function (data) {
            alert("Upload successful!", data);
          },
          error: function (data) {
            alert("An error occurred.", data);
          }
        });
      });
    });
  </script>
</div>
{% endblock content %}
